<!DOCTYPE HTML>
<html>
<head>
    <title>Spy App</title>
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <meta name="keywords" content="Google maps, jQuery, plugin, mobile, iphone, ipad, android, HTML5, Geo search"/>
    <meta name="description" content="Geo search example with jQuery mobile, Google maps and HTML5"/>
    <meta http-equiv="content-language" content="en"/>

    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/>

    
    <link rel="stylesheet" href="jquery.mobile-1.0a4.min.css"/>
    <link rel="stylesheet" href="ui/jquery-ui-1.8.13.css"/>
    <link rel="stylesheet" href="launch48.css"/>

    <script src="http://www.google.com/jsapi?key=ABQIAAAAahcO7noe62FuOIQacCQQ7RTHkUDJMJAZieEeKAqNDtpKxMhoFxQsdtJdv3FJ1dT3WugUNJb7xD-jsQ" type="text/javascript"></script>
    

    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.13.min.js"></script>
    <script type="text/javascript" src="ui/jquery.ui.map.js"></script>
    <script type="text/javascript" src="poscalculation.js"></script>


    <style rel="stylesheet">
        body {
            background: #ddd;
        }

        .ui-body-c a.ui-link {
            color: #008595;
            font-weight: bold;
            text-decoration: none;
        }

        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

        h2 {
            font-size: 16px;
            overflow: hidden;
            white-space: nowrap;
            display: block;
        }

        .more {
            text-align: center;
        }
    </style>
    <script type="text/javascript">
        google.load("maps", "3", {'other_params':'sensor=true'});
        google.load("jquery", "1.5");
    </script>
    <script type="text/javascript">
        // Demonstration purpose only...
        $(document).bind("mobileinit", function () {
            $.mobile.ajaxEnabled = true;
        });
    </script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.mobile-1.0a4.min.js"></script>
    <script type="text/javascript" src="ui/jquery.ui.map.js"></script>
    <script type="text/javascript" src="maps.google.polygon.containsLatLng.js"></script>

</head>

<body>

<div id="gmap-4" class="" data-role="page">

    <div data-role="header">

        

    </div>

    <script type="text/javascript">

        var mapLoaded = false;
        var myPosition = null;
        var mainMap = null;
        var currentTargetArea = null;
        var currentTimeout = null;
        var weaponPrimed = false;

         function getAgentLocations() {
            $.ajax({
                url: "http://scubaholic.co.uk/agents.php?callback=?",
                dataType: 'json',
                success: loadAgents,
                error: function() {alert("Error")}
            });
        }

        //var coordinate = new GLatLng(40, -90);
        //var polygon = new GPolygon([], "#000000", 1, 1, "#336699", 0.3);
        //var isWithinPolygon = polygon.containsLatLng(coordinate);

        function drawTargetArea(bearing1, bearing2) {
            if (currentTargetArea) currentTargetArea.setMap(null);
            var pos1 = getNextLatLon(myPosition.lat(), myPosition.lng(), bearing1);
            var pos2 = getNextLatLon(myPosition.lat(), myPosition.lng(), bearing2);
            var triangleCoords = [
                myPosition,
                new google.maps.LatLng(pos1.latitude, pos1.longitude),
                new google.maps.LatLng(pos2.latitude, pos2.longitude)
            ];
            currentTargetArea = new google.maps.Polygon({
                paths: triangleCoords,
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.35
            });
            currentTargetArea.setMap(mainMap);
        }

        function rotateTargetArea(bearing) {
            if (bearing < 360) {
                console.log(bearing);
                drawTargetArea(bearing, bearing+30);
                currentTimeout = setTimeout('rotateTargetArea(' + (bearing+5) + ')', 50);
            } else {
                setTimeout('currentTargetArea.setMap(null)')
                weaponPrimed = false;
            }
        }

        $('#gmap-4').live("pageshow", function() {
            if (!mapLoaded) {

                if (navigator.geolocation) {
                    watch = navigator.geolocation.watchPosition(
                        function(position) {
                            myPosition = getLatLng(position);

                            $('#map_canvas_2').gmap({ 'center': myPosition,'zoom': 14, 'streetViewControl': false, 'mapTypeControl': false, 'navigationControl': false, 'callback': function (map) {
                                mainMap = map;
                                $('#map_canvas_2').gmap('clearMarkers');
                                $('#map_canvas_2').gmap('addMarker', { 'bound': true, icon: 'images/me.png', 'position':new google.maps.LatLng(position.coords.latitude, position.coords.longitude) }, function(map, marker) {
                                    map.panTo(marker.getPosition());
                                    getAgentLocations();
                                });
                            }
                            });
                        }
                    )

                    mapLoaded = true;
                }

            }

        });

        function getLatLng(position) {
            return new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        }

        $('#gmap-4').live("pagehide", function() {
            if (navigator.geolocation) {
                navigator.geolocation.clearWatch(watch);
            }
        });

        $('#gmap-4').live("pagecreate", function() {
            var watch;
        });

        function primeWeapon(marker) {
            clearTimeout(currentTimeout);
            rotateTargetArea(0)
        }

        function hit(marker) {
            clearTimeout(currentTimeout);
            if (currentTargetArea.containsLatLng(marker.position)) {
                $("#hit").removeClass("hidden").addClass("visible");
            }
            else {
                alert("miss");                
            }
            currentTargetArea.setMap(null);
        }

        function aimAndFire(marker) {
            if (!weaponPrimed) {
                primeWeapon(marker);
                weaponPrimed = true;
            } else {
                hit(marker);
                weaponPrimed = false;
            }
        }

        function loadAgents(data) {
            $.each(data, function(key, value) {
                var icon = (value.status === "friend") ? "friend" : "enemy";
               $('#map_canvas_2').gmap('addMarker', { 'title': value.id, 'bound': true, icon: 'images/' + icon + '.png', 'position':new google.maps.LatLng(value.position.lat, value.position.lng) }, function(map, marker) {
                    $(marker).click(function() {
                        aimAndFire(marker);
                    });
                    map.panTo(marker.getPosition());
               });
            });
            $("#close").click(function() {
                $("#hit").removeClass("visible").addClass("hidden");
            });
        }

        
    </script>
    <div class="page" data-role="content">

        <div id="map_canvas_2" style="height:450px;"></div>

        <div class="popup" id="hit">

            <h2>HIT!</h2>

            <a href="javascript:void(0)" id="close">Close</a>
        </div>
    </div>
    
    <div class="weapon-select">
        
        <form>
            <fieldset>
                <div id="radio" class="guns">
                    
                        <input type="radio" id="radio1" name="radio" checked="checked" /><label for="radio1">Gun 1</label>
                        <input type="radio" id="radio2" name="radio" /><label for="radio2">Gun 2</label>
                        <input type="radio" id="radio3" name="radio" /><label for="radio3">Gun 3</label>
                        <input type="radio" id="radio4" name="radio" /><label for="radio4">Gun 4</label>
                </div>
            </fieldset>
        </form>      
        
    </div>

</div>
</body>

</html>
